{% extends 'baseAuthenticatedIframe.html.twig' %}

{% block title %}Students{% endblock %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}

{% block body %}

<div class="uk-container">
    <div class="uk-grid" uk-grid>
        <div class="uk-width-1-1">

            {{ form_start(form, {'attr': {'class': 'uk-grid-small', 'uk-grid': 'uk-grid'}}) }}
            <div class="uk-width-1-4">
                {{ form_widget(form.firstName, {'attr': {'class': 'uk-input', 'placeholder': 'First Name'}}) }}
            </div>
            <div class="uk-width-1-4@s">
                {{ form_widget(form.lastName, {'attr': {'class': 'uk-input', 'placeholder': 'Last Name'}}) }}
            </div>
            <div class="uk-width-1-4@s">
                {{ form_widget(form.email, {'attr': {'class': 'uk-input', 'placeholder': 'Email'}}) }}
            </div>
            <div class="uk-width-1-4@s">
                {{ form_widget(form.username, {'attr': {'class': 'uk-input', 'placeholder': 'Username'}}) }}
            </div>
            <div class="uk-width-1-4@s">
                {{ form_widget(form.educatorUsers, {'attr': {'class': 'uk-input', 'placeholder': 'Filter By Supervising Educator'}}) }}
            </div>

            <div class="uk-width-1-4@s">
                <button class="uk-button uk-button-default">Search</button>
                <a class="uk-button uk-button-default" href="{{clearFormUrl }}">Clear</a>
            </div>
            {{ form_end(form) }}

            <div class="uk-overflow-auto" style="font-size: 0.8em">
                <table class="uk-table uk-table-small uk-table-divider" style="width: 1400px;">
                    <tr>
                        <th>Student</th>
                        <th>Email</th>
                        <th>Username</th>
                        <th>Supervising Teacher(s)</th>
                        <th>Temp Password</th>
                        <th colspan="3"></th>
                    </tr>

                {% for studentUser in pagination %}

                    {% if studentUser.archived != true %}

                        <tr id="user_{{ studentUser.id }}">
                            <td>
                                <input type="checkbox" class="group-edit-supervising-teacher" name="studentUser[]" data-name="{{ studentUser.firstName }} {{ studentUser.lastName }}" value="{{ studentUser.id }}" />
                                <img class="uk-border-circle" width="25" height="25" src="{{ ( attribute(studentUser, 'photo') is defined and studentUser.photo ) ? asset(uploaded_asset(studentUser.photoPath))|imagine_filter('squared_thumbnail_small') : asset('build/images/avatar.png') }}">
                                {{ studentUser.lastName }}, {{ studentUser.firstName }}<br>
                                {{ excerpt_length( studentUser.briefBio, 100 ) }}
                            </td>

                            <td>{{ studentUser.email ? studentUser.email : "N/A"}}</td>

                            <td>{{ studentUser.username ? studentUser.username : "N/A"}}</td>

                            <td id="student_{{ studentUser.id }}">
                                {% set educatorIds = [] %}
                                {% for educator in studentUser.educatorUsers %}
                                    {% set educatorIds = educatorIds|merge([{ id: educator.id }]) %}
                                {% endfor %}
                                <span class="fa fa-pencil edit-supervising-teacher" style="float: right; cursor: pointer" data-id="{{ studentUser.id }}" data-name="{{ studentUser.firstName }} {{ studentUser.lastName }}" data-educators="{{ educatorIds|json_encode() }}" uk-tooltip="Edit Supervising Teacher(s)"></span>

                                {% for educator in studentUser.educatorUsers %}
                                    <dt>{{ educator.lastName }}, {{ educator.firstName }}</dt>
                                {% endfor %}
                            </td>

                            <td>{{ studentUser.tempPassword ?  studentUser.tempPassword : "N/A"}}</td>

                            <td colspan="3">
                                <a target="_parent" href="{{ path('profile_edit', { "id": studentUser.id }) }}" class="uk-button uk-button-default uk-button-small" style="margin-bottom: 8px;">Edit</a>
                                <a target="_parent" href="{{ path('profile_index', { "id": studentUser.id }) }}" class="uk-button uk-button-default uk-button-small" style="margin-bottom: 8px;">View</a>
                                <form class="uk-inline" action="{{ path('remove_student', { "id": studentUser.id }) }}" method="POST" style="margin-bottom: 8px;">
                                    <input type="hidden" name="schoolAdminId" value="{{ user.id }}">
                                    <button class="uk-button uk-button-danger uk-button-small uk-margin-small-right iframe-remove-user" type="submit">Remove</button>
                                </form>
                            </td>
                        </tr>

                    {% endif %}

                {% endfor %}

                </table>
            </div>

            <div class="navigation">
                {{ knp_pagination_render(pagination) }}
            </div>


            <div id="bulk-editing" style="display:none">
                <button class="uk-button uk-button-primary" id="bulk-edit-teachers">Bulk Edit Supervising Teachers</button>
            </div>
        </div>
    </div>
</div>


<div id="individual-student-modal" uk-modal>
    <div class="uk-modal-dialog uk-modal-body">
        <div class="users">
            <h2 class="uk-modal-title">Update List of Supervising Teachers</h2>
            <p>Please select the teacher(s) you would like to assign to <span id="student_name"></span></p>
            <form method="post" enctype="multipart/form-data" action="" id="individual-student-form">
                <input type="hidden" name="schoolId" value="{{ school.getId() }}" />
                {% for educator in school.educatorUsers %}
                    <label><input type="checkbox" class="individual-educators" id="individual_educator_{{ educator.id }}" name="educatorUser[]" value="{{ educator.id }}" /> {{ educator.lastName }}, {{ educator.firstName }}</label><br />
                {% endfor %}
            
                <p class="uk-text-right">
                    <button class="uk-button uk-button-default uk-modal-close" type="button">Cancel</button>
                    <button class="uk-button uk-button-primary" type="submit">Save</button>
                </p>
            </form>
        </div>
    </div>
</div>

<div id="bulk-student-modal" uk-modal>
    <div class="uk-modal-dialog uk-modal-body">
        <div class="users">
            <h2 class="uk-modal-title">Update List of Supervising Teachers</h2>
            <p>Please select the teacher(s) you would like to assign to the following list of students. This action will <strong>REPLACE</strong> the teachers assigned to these students.</p>
            <p id="bulk_student_list"></p>
            <form method="post" enctype="multipart/form-data" action="/dashboard/students/bulk_update_educators" id="bulk-student-form">
                <input type="hidden" name="schoolId" value="{{ school.getId() }}" />
                {% for educator in school.educatorUsers %}
                    <label><input type="checkbox" class="bulk-educators" name="educatorUser[]" value="{{ educator.id }}" /> {{ educator.lastName }}, {{ educator.firstName }}</label><br />
                {% endfor %}
                <div id="bulk_student_ids"></div>
                <p class="uk-text-right">
                    <button class="uk-button uk-button-default uk-modal-close" type="button">Cancel</button>
                    <button class="uk-button uk-button-primary" type="submit">Save</button>
                </p>
            </form>
        </div>
    </div>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
/**
 * Fix iframe reloading issue when deleting users
 */
$('.iframe-remove-user').on('click', function(e) {
    e.preventDefault();
    var item = $(this).parents("form:first");
    var ans = confirm('Are you sure you want to remove this student?');
    if(ans) {
        $.post( $(item).attr('action'), { 'iframe': true, 'schoolAdminId': $(item).find("input[name='schoolAdminId']").val() }, function(data){

        if(data.success) {
            $('#user_' + data.id).remove();
        } else {
            alert('Error deleting user');
        }
      });
    }

});

// Edit individual student's supervising teachers ///

$(document).on('click', '.edit-supervising-teacher', function() {
    var studentId = $(this).data('id');
    var studentName = $(this).data('name');
    var educatorIds = $(this).data('educators');

    $('#individual-student-form').attr('action', "/dashboard/students/" + studentId + "/update_educators");
    $('#student_name').html( studentName );


    // Clear out all checked users
    $(".individual-educators").prop('checked', false);

    // Loop through educators and check selected educators
    console.log(educatorIds);
    $.each(educatorIds, function(key, user) {
        $("#individual_educator_" + user.id).prop('checked', true);
    })

    UIkit.modal("#individual-student-modal").show();
});

$('#individual-student-form').on('submit', function(e){
    e.preventDefault();
    var form = $(this);

    $.post( $(form).attr('action'), $(form).serialize(), function(data){
        if(data.success === true) {

            var ids = [];
            var names = '';
            $.each(data.educators, function(id, user){
                ids.push({ 'id': user.id });
                names += '<dt>' + user.name + '</dt>';
            });

            var html = "<span class=\"fa fa-pencil edit-supervising-teacher\" style=\"float: right; cursor: pointer\" data-id=\"" + data.student_id + "\" data-name=\"" + data.student_name + "\" data-educators=" + JSON.stringify(ids).replace(/ /g, '') + " uk-tooltip=\"Edit Supervising Teacher(s)\"></span>" + names;
            $('#student_' + data.student_id ).html(html);
        }

        UIkit.modal("#individual-student-modal").hide();
    });
});


// Edit bulk student supervising teachers ///
$('.group-edit-supervising-teacher').on('click', function(){
    if($('.group-edit-supervising-teacher:checked').length > 0) {
        $('#bulk-editing').show();
    } else {
      $('#bulk-editing').hide();  
    }
});

$('#bulk-edit-teachers').on('click', function(){
    var names = [];
    $('#bulk_student_ids').html('');

    $.each( $('.group-edit-supervising-teacher:checked'), function(id, data){
        names.push($(data).data('name'));
        $("#bulk_student_ids").append('<input type="hidden" name="student[]" value="' + $(data).val() + '" />');
    });

    // Clear out all checked users and student ids
    $(".bulk-educators").prop('checked', false);

    $("#bulk_student_list").html( '<strong>Students:</strong> ' + names.join(', ') );

    UIkit.modal("#bulk-student-modal").show();
});

$("#bulk-student-form").on('submit', function(e) {
    e.preventDefault();
    var form = $(this);

    $.post( $(form).attr('action'), $(form).serialize(), function(data){
        if(data.success === true) {

            $.each(data.students, function(id, student){
                var ids = [];
                var names = '';
                $.each(student.educators, function(id, user){
                    ids.push({ 'id': user.id });
                    names += '<dt>' + user.name + '</dt>';
                });

                var html = "<span class=\"fa fa-pencil edit-supervising-teacher\" style=\"float: right; cursor: pointer\" data-id=\"" + student.student_id + "\" data-name=\"" + student.student_name + "\" data-educators=" + JSON.stringify(ids).replace(/ /g, '') + " uk-tooltip=\"Edit Supervising Teacher(s)\"></span>" + names;
                $('#student_' + student.student_id ).html(html);
            });
        }

        $('.group-edit-supervising-teacher').prop("checked", false);
        $("#bulk-editing").hide();

        UIkit.modal("#bulk-student-modal").hide();
    });
});
</script>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {# <script src="{{ asset('build/educators.js') }}"></script> #}
{% endblock %}



